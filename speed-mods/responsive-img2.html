{{!--  
    Image classes
    "responsive-img" - applied to all img tags generated by this code. Use this class to control how the background looks before any image is loaded.
    "loading-auto" - applied when no loading mode is specified. i.e. not lazy. Same as the old 'disabled' setting.
    "loading-lazy" - applied when lazy-loading is enabled
    "placeholder-auto" - a transparent image is used as the placeholder before the main image loads. e.g. not LQIP
    "placeholder-lqip" - applied when LQIP is enabled. Use this to make sure the LQIP background-image is inline with the main image.
    "lazysizes-auto" - Lazysizes will be used if native lazy-loading is not supported by the browser
    "lazysizes-disabled" - Lazysizes will not be used even if native lazy-loading is not supported by the browser
    "lazyload" - applied when lazy-loading and Lazysizes is enabled so that Lazysizes can target them automatically.

    LQIP
    The Low Quality Image Placeholder is now implemented via CSS using background-image. This is to make it compatible with a browsers native lazy-loading.
    Add the following style to your theme so that the LQIP image aligns well with the main image that replaces it:

    <style>          
        img.placeholder-lqip {
            background-repeat: no-repeat;
            background-size: contain;
            background-position: center;
        }
        img.placeholder-lqip.normalloaded, img.placeholder-lqip.lazyloaded {
            background-image: none !important;
        }
    </style>

    The use of CSS for LQIP may conflict with things. Like the main product image gets replaced by gallery images that may not fully cover the LQIP. The base.html script 
    can fix that by making sure the 'lazyloaded' or 'normalloaded' class is added to the image once it has been loaded. And the above CSS removes the background image.

    I also noticed the product gallery system is very slow at loading the alternate images. prefetch may help there. 
    However it seems the mechanism will reload the large image every time it is selected, even if the image has been previously loaded?

    Lazysizes
    By default the Lazysizes library is used to lazy-load an image.
    It is possible to switch to using the browsers native lazy-loading mechanism when supported.
    The best way at the moment is to include a script to the head of the base.html that dynamically converts images to using the native lazy-loading when possible.
    native lazy-loading has a few requirements:
    'sizes' must be specified. This is so the native system can decide which responsive image to use.
    (Lazysizes dynamically works out the 'sizes' value so does not require it to be set)
    If native lazy-loading is not available (e.g. Safari) the system will stick to Lazysizes.
    You can disable the Lazysizes fallback for each image using the lazysizes='disabled'
    With the script added you can remove the standard Lazysizes loading code so that it is only loaded if required.

    The use of CSS LQIP and native lazy-loading means that the user sees a gradual quality improvement as the full size image is loaded.
    With Lazysizes an image swap is done so the image goes from low quality to high quality in the last moment.

    Arguments
    'loading': 'auto' (default), 'lazy', 'eager'
       This sets the img loading attribute. Use 'lazy' for images that are not typically initially seen.
       'auto' leaves it up to the browser to decide how to load the image. Typically this means it is loaded as soon as possible. Good for top of the page images.
       'lazy' is good for images that are lower down on the page, especially when the page is long and contains lots of images
       'eager' is good for lower down images that for some reason need to be loaded early on.
       If 'lazy' is set, Lazysizes or the browsers native lazy-loading mechanism will be used.

    'importance': 'auto' (default), 'high', 'low'
       In the future importance="high" will cause the browser to load an image much sooner.
       This is very good for images that are initially visible on a page. 
       It is very good at reducing the Core Web Vitals LCP score.
       Importance of 'high' will also cause the LQIP image to be preloaded at a high importance level.
       
    'placeholder': 'auto' (default), 'lqip'
       By default a blank image is used before the main image is loaded. The 'placeholder-auto' class can be used to decide how it looks.
       'lqip' means a Low Quality Image Placeholder is loaded fist... 
       On slower connections the user will initially see a blurry version of the image while the full version of the image loads.
       This can provide a better user experience but does add the loading of an extra small image.
       It's of little value to use 'lqip' on smaller images (LQIP images are 80 pixels wide) or images that typically load before the page is rendered (preloaded or importance high).

    'sizes':
       https://developer.mozilla.org/en-US/docs/Learn/HTML/Multimedia_and_embedding/Responsive_images
       The sizes attribute value.  
       The sizes attribute defines how the browser should pick the correct image to use as defined in srcset.          
       If sizes is not supplied, the system will use Lazysizes which calculates 'sizes' for you.
       If 'sizes' is set to a single pixel width (e.g. '500px') only a single image of that width will be provided which reduces code bloat and complexity. 

    'lazysizes': 'auto' (default), 'disabled'
       By default Lazysizes will be used.
       The optional base.html code will dynamically switch to using native lazy-loading if 'sizes' or 'x1' are set and the browser supports it.
       If set to 'disabled' then native lazy-loading is used by default, without the need for the base.html code. Browsers that do not support native lazy-loading will load the images as normal. i.e. no lazy-loading.
       Lazysizes generates the 'sizes' attribute automatically which would sometimes be more accurate than when we manually set 'sizes'
       However Lazysizes needs to wait for rendering to do this, meaning image loading is delayed and can't be reliably preloaded.
            
    'fallback_size':
        This is the size to use for this image in legacy browsers that do not support srcset.
        Can be defined as a pixel bounding-box size (e.g. "123x123) or inherent width (e.g. "123w").
    
    'class':
        Extra CSS classes to add to the image, e.g. "card-image".    
    
    'otherAttributes':
        Any other HTML attributes you want on the img tag, for example "height='100' width='100'"
        Specifying height and width can reduce Layout Shifts. They can also be specified in CSS
    
    'default_image':
        The default image to use if `image` is undefined or falsy. Should be a theme asset, usually defined as a relative
        path in the theme config. If a default image is not provided, you'll get an blank image if the primary
        image is undefined.
        The default image is never lazy-loaded and does not use a LQIP image
    
    'lqip_size':
        If you want to specify a particular size for the LQIP image, you can do so with this argument. 
        A default of 80 pixels wide will be used otherwise.
        
    Backward compatibility:
    The old 'lazyload' parameter values will map to:
    'lazyload' - loading='lazy'
    'lazyload-lqip' - loading='lazy', placeholder='lqip'
    'disabled' - default values
    The new parameters override the 'lazyload' parameter
    
      Ideas
      Ability to use browser setting for Save-Data or network speed to disable LQIP and maybe even reduce image sizes.
    --}}

    {{#if (isString sizes) '===' false}}
    {{assignVar 'responsiveSizes' (get 'string' sizes)}}
    {{else if sizes}}
    {{assignVar 'responsiveSizes' sizes}}
    {{else}}
    {{assignVar 'responsiveSizes' 'auto'}}
    {{/if}}

    {{#all (if (occurrences (getVar 'responsiveSizes') ',') '===' 0) (if (occurrences (getVar 'responsiveSizes') 'p') '===' 1)}}
    {{assignVar 'responsive1x' (get 'string' (concat (first (split (getVar 'responsiveSizes') 'p')) 'w'))}}
    {{else}}
    {{assignVar 'responsive1x' '-'}}
    {{/all}}

    {{#if loading}}
    {{assignVar 'responsiveLoading' loading}}
    {{else if lazyload '===' 'lazyload'}}
    {{assignVar 'responsiveLoading' 'lazy'}}
    {{else if lazyload '===' 'lazyload+lqip'}}
    {{assignVar 'responsiveLoading' 'lazy'}}
    {{else}}
    {{assignVar 'responsiveLoading' 'auto'}}
    {{/if}}

    {{#if placeholder}}
    {{assignVar 'responsivePlaceholder' placeholder}}
    {{else if lazyload '===' 'lazyload+lqip'}}
    {{assignVar 'responsivePlaceholder' 'lqip'}}
    {{else}}
    {{assignVar 'responsivePlaceholder' 'auto'}}
    {{/if}}

    {{#all (if (getVar 'responsivePlaceholder') '===' 'lqip') (if importance '===' 'high') (if image)}}  
    <link rel="preload" as="image" href="{{getImageSrcset image 1x=(default lqip_size '80w')}}" importance="high">
    {{/all}}

    <img  
    {{#if image}}
         src="{{getImageSrcset image 1x=(default fallback_size '160w')}}" alt="{{image.alt}}" 

         {{#if importance}}importance="{{importance}}"{{/if}} 
      
         {{#if (getVar 'responsiveLoading') '===' 'lazy'}}
         loading="lazy"
         {{#if lazysizes '!==' 'disabled'}}
         data-sizes="auto"
         {{!-- always this so no default image if srcset is supported --}}
         srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" 
         {{#if (getVar 'responsive1x') '!==' '-'}}
         data-srcset="{{getImageSrcset image 1x=(getVar 'responsive1x')}}"
         {{else}}       
         data-srcset="{{getImageSrcset image use_default_sizes=true}}"{{#if sizes}} sizes="{{sizes}}"{{/if}}
         {{/if}}
         {{/if}}
         {{else}}
         {{#if (getVar 'responsiveLoading') '!==' 'auto'}}
         loading="{{getVar 'responsiveLoading'}}"
         {{/if}}
         {{#if (getVar 'responsive1x') '!==' '-'}}
         srcset="{{getImageSrcset image 1x=(getVar 'responsive1x')}}"
         {{else}}       
         srcset="{{getImageSrcset image use_default_sizes=true }}"{{#if sizes}} sizes="{{sizes}}"{{/if}}
         {{/if}}
         {{/if}}

         class="responsive-img{{#if class}} {{class}}{{/if}} lazysizes-{{default lazysizes 'auto'}}{{#if (getVar 'responsiveLoading') '===' 'lazy'}} loading-lazy{{#if lazysizes '!==' 'disabled' }} lazyload{{/if}}{{else}} loading-{{getVar 'responsiveLoading'}}{{/if}}{{#if (getVar 'responsivePlaceholder') '===' 'lqip'}} placeholder-lqip" style="background-image: url('{{getImageSrcset image 1x=(default lqip_size '80w')}}')"{{else}} placeholder-auto"{{/if}}
    
    {{else if default_image}}
    src="{{cdn default_image}}" 
    alt="{{lang 'products.card_default_image_alt'}}" 
    class="responsive-img loading-auto placeholder-auto default-image{{#if class}} {{class}}{{/if}}"
    {{else}}
    src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" 
    alt="" 
    class="responsive-img loading-auto placeholder-auto no-image{{#if class}} {{class}}{{/if}}"
    {{/if}}
    
    {{otherAttributes}} />
    