<script data-cfasync="false">   
/*
    Web Site Advantage: Tag Rocket Criteo [v2.1] 
    Criteo tags
    https://bigcommerce.websiteadvantage.com.au/tag-rocket/articles/tag-rocket-api/
    Copyright (C) 2021 Web Site Advantage
*/
!function(w,t){
    var CRTO_PartnerID = 'REPLACE_WITH_YOUR_PARTNER_ID';
    var productIdentifier = function(product) {return ''+product.productId}; // productId, productSku

    var debug = false;
    
    // https://help.criteo.com/kb/guide/en/all-criteo-onetag-events-and-parameters-vZbzbEeY86/Steps/775825

    w[t]=w[t]||{};var T=w[t];T.i=T.i||[];if(!T.init)T.init=function(f){T.i.push(f)};
    
    T.init(async function(){
        var deviceType = /iPad/.test(navigator.userAgent) ? "t" : /Mobile|iP(hone|od)|Android|BlackBerry|IEMobile|Silk/.test(navigator.userAgent) ? "m" : "d";

        window.criteo_q = window.criteo_q || [];

        var scriptTagAdded = false;
        function addScriptTag() {
            if (!scriptTagAdded) {
                scriptTagAdded = true;
                T.addScriptTag('https://dynamic.criteo.com/js/ld/ld.js?a='+CRTO_PartnerID);
            }    
        }

        // https://help.criteo.com/kb/guide/en/criteo-onetag-advanced-settings-M2TiX6m90K/Steps/886908,887075,1948827,1957333
        async function sha256Async(message) {
            // encode as UTF-8
            const msgBuffer = new TextEncoder('utf-8').encode(message);

            // hash the message
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);

            // convert ArrayBuffer to Array
            const hashArray = Array.from(new Uint8Array(hashBuffer));

            // convert bytes to hex string
            const hashHex = hashArray.map(b => ('00' + b.toString(16)).slice(-2)).join('');
            return hashHex;
        }

        var commonEvents = [];
        async function setCommonEventsAsync() {

            commonEvents = [];
           
            commonEvents.push({event: "setAccount", account: CRTO_PartnerID});
            commonEvents.push({event: "setSiteType", type: deviceType});

            if (T.userData.email) {
                commonEvents.push({event: "setEmail", email: await sha256Async(T.userData.email.trim().toLowerCase()), hash_method: "sha256"});
            }
            else {
                commonEvents.push({event: "setEmail", email: "", hash_method: "none"});
            }

            if (T.userData.postal_code){
                commonEvents.push({event: "setZipcode", zipcode: T.userData.postal_code });
            }

            if (T.userData.phone){
                commonEvents.push({ event: "setSha256HashedPhoneNumber", phone_number: await sha256Async(T.userData.phone) });
            }

            if (T.userData.id){
                commonEvents.push({ event: "setCustomerId", id: await sha256Async(T.userData.id) });
            }

            // setRetailerVisitorId - a cookie value that identifies a user
        }

    
        function send(event) {
            event.ecpplugin = "BigCommerce-TagRocket";

            // push the commonEvents and this event into the tag queue
            const eventList = Array.from(commonEvents);

            eventList.push(event);

            if (debug) {
                console.log("Criteo "+event.event, eventList);
            } 
            window.criteo_q.push(eventList);
        }

        await setCommonEventsAsync();

        {{#if settings.request.absolute_path '===' '/'}}
        send({event: "viewHome"});
        {{else if page_type '===' 'product'}}
        // will send a viewItem
        {{else if page_type '===' 'cart'}}
        // will send a viewBasket
        {{else if page_type '===' 'category'}}
        // will send a viewList
        {{else if page_type '===' 'brand'}}
        // will send a viewList
        {{else if page_type '===' 'search'}}
        // will send a viewList
        {{else if page_type '===' 'orderconfirmation'}} 
        // will send a trackTransaction 
        {{else}}
        send({event:"viewPage"});
        {{/if}}

        if (T.consent.targetingAdvertising) {
            addScriptTag();
            T.addPreconnectTag('https://dynamic.criteo.com');
            T.addPreconnectTag('https://static.criteo.net');
            T.addPreconnectTag('https://sslwidget.criteo.com');
            T.addPreconnectTag('https://gum.criteo.com');
        }

        // https://help.criteo.com/kb/guide/en/criteo-onetag-advanced-settings-M2TiX6m90K/Steps/886908,887077
        // Criteo wants the first 3 products
        // search is an exception, it can be less than three
        // Criteo will send a viewPage if no events fire for a few seconds
        var viewListSent = false;
        function sendViewList(data, listName, min) {
            if (!viewListSent) {

                // directly getting all known products. this could expand, e.g. using a dynamic search provider
                var productIdentifiers = T.products.flat().map(function(item){return productIdentifier(item)});

                if (productIdentifiers.length >= min) {
                    viewListSent = true;

                    var event = {event: "viewList", 
                        category: listName, 
                        item: productIdentifiers.slice(0, 3) // only send the first 3 products
                    };

                    // page_number
                    // filters

                    if (data.search) {
                        event.keywords = data.search;
                    }

                    send(event);
                }
            } 
        }

        T.on('.*',async function(data, eventName){
            switch(eventName) {
                case "UserDataUpdated":
                    await setCommonEventsAsync();
                    break;
                case "ConsentChanged":
                    if (T.consent.targetingAdvertising) {
                        addScriptTag();
                    }
                    break;
                {{#if page_type '===' 'product'}} 
                case "ProductPage":
                    send({event: "viewItem", 
                        item: productIdentifier(data),
                        availability: "{{~#if product.stock_level '===' '0'}}0{{~else}}1{{~/if}}", // stock_level is a string if present
                        price: data.price,
                        currency: data.currency                       
                    });
                    break;
                {{/if}}
                {{#if page_type '===' 'search'}}    
                case "ProductsVisible":
                    sendViewList(data, "Search", 1); // search can have less than 3 products      
                    break;
                {{/if}}
                {{#if page_type '===' 'category'}}    
                case "ProductsVisible":
                    sendViewList(data, {{{json category.name}}}, 3);                       
                    break;
                {{/if}}
                {{#if page_type '===' 'brand'}}    
                case "ProductsVisible":
                    sendViewList(data, {{{json brand.name}}}, 3);                        
                    break;
                {{/if}}
                {{#if page_type '===' 'cart'}}
                case "CartPage":
                    var items = data.items.map(function(item){
                        return {
                            'id': productIdentifier(item),
                            'price': item.price,
                            'quantity': item.quantity
                        }
                    });

                    send({event: "viewBasket", currency: data.currency.code, item: items});
                    break;
                {{/if}}
                case "CartItemChanged": 
                    if (data.change > 0) {
                        send({event: "addToCart", currency: data.currency, item:[
                            {
                                'id': productIdentifier(data.item),
                                'price': data.item.price,
                                'quantity': data.change
                            }
                        ]});
                    }
                    break;
                {{#if page_type '===' 'orderconfirmation'}}                        
                case "CheckoutStep5OrderCompleted":
                    var items = data.items.map(function(item){
                        return {
                            'id': productIdentifier(item),
                            'price': item.price,
                            'quantity': item.quantity
                        }
                    });

                    send({event: "trackTransaction", id: data.orderId, currency: data.currency.code, item: items});
                    break;
                {{/if}}
            }                    
        });      
    })
}(window,"TagRocket")
</script>